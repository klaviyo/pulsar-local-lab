#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#

# Minikube-optimized values for local development
# Minimal resource usage, single replicas, no persistence

pulsar:
  ## deployed with emptyDir
  volumes:
    persistence: false

  # disabled AntiAffinity
  affinity:
    anti_affinity: false

  # disable auto recovery
  components:
    autorecovery: false
    pulsar_manager: true

  zookeeper:
    replicaCount: 1

  bookkeeper:
    replicaCount: 2
    configData:
      dbStorage_writeCacheMaxSizeMb: "256"
      dbStorage_readAheadCacheMaxSizeMb: "256"
      dbStorage_rocksDB_writeBufferSizeMB: "64"
      dbStorage_rocksDB_blockCacheSize: "33554432"
      PULSAR_MEM: "-Xms256m -Xmx512m -XX:MaxDirectMemorySize=768m"
    podMonitor:
      enabled: true
      interval: 30s

  broker:
    replicaCount: 1
    configData:
      autoSkipNonRecoverableData: "true"
      managedLedgerDefaultEnsembleSize: "1"
      managedLedgerDefaultWriteQuorum: "1"
      managedLedgerDefaultAckQuorum: "1"
      maxPublishRatePerTopicInMessages: "100000"
      maxPublishRatePerTopicInBytes: "104857600"
      maxMessagePublishBufferSizeInMB: "512"
      dispatchThrottlingRatePerTopicInMsg: "100000"
    podMonitor:
      enabled: true
      interval: 30s

  proxy:
    replicaCount: 1
    podMonitor:
      enabled: true
      interval: 30s

  zookeeper:
    podMonitor:
      enabled: true
      interval: 30s

  # Enable monitoring stack with Grafana dashboards
  kube-prometheus-stack:
    enabled: true
    prometheus:
      enabled: true
      prometheusSpec:
        retention: 24h
        # Reduce scrape frequency globally to minimize overhead
        scrapeInterval: 30s
        evaluationInterval: 30s
        storageSpec:
          volumeClaimTemplate:
            spec:
              accessModes: ["ReadWriteOnce"]
              resources:
                requests:
                  storage: 10Gi
    grafana:
      enabled: true
      adminPassword: admin
      sidecar:
        dashboards:
          enabled: true
          label: grafana_dashboard
          labelValue: "1"
          searchNamespace: ALL
      persistence:
        enabled: false
